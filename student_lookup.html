<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Feedback History</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- Base Styles from Main Dashboard --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #310e68;
            background-image: linear-gradient(316deg, #310e68 0%, #5f0f40 74%);
            color: #333;
            padding: 8px;
            overflow-y: auto;
            overflow-x: hidden;
        }

        .container {
            max-width: 1600px;
            margin: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
            padding: 5px 8px 15px 8px;
            animation: slideIn 0.4s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1, h2 {
            text-align: center;
        }

        /* --- Main Header --- */
        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 16px;
            position: relative;
        }
        .main-header h1 {
            color: #ffffff;
            font-weight: 700;
            font-size: 24px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.25);
            flex-grow: 1;
            text-align: center;
        }

        /* --- 3D Button Styles --- */
        .btn-3d {
            padding: 12px 20px;
            font-weight: 600;
            font-size: 12px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Inter', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transform-style: preserve-3d;
            height: 44px;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        .btn-export {
            background: linear-gradient(145deg, #4a3aff, #6254ff);
            color: white;
            box-shadow: 0 4px 0 #3027b3, 0 6px 12px rgba(74, 58, 255, 0.3);
        }
        .btn-export:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 0 #3027b3, 0 8px 16px rgba(74, 58, 255, 0.4);
        }
        .btn-export:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #3027b3, 0 4px 8px rgba(74, 58, 255, 0.2);
        }
        .btn-refresh {
            background: linear-gradient(145deg, #ffffff, #f0f0f0);
            color: #333;
            border: 1px solid #ddd;
            box-shadow: 0 4px 0 #c0c0c0, 0 6px 12px rgba(0, 0, 0, 0.1);
        }
        .btn-refresh:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 0 #c0c0c0, 0 8px 16px rgba(0, 0, 0, 0.15);
        }
        .btn-refresh:active {
            transform: translateY(2px);
            box-shadow: 0 2px 0 #c0c0c0, 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        /* --- Filters Bar --- */
        .filters {
            display: flex;
            gap: 15px;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 16px 24px;
            border-radius: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border: 1px solid #e6e6e6;
            flex-wrap: wrap;
        }
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .filter-group label {
            font-weight: 600;
            color: #333;
            font-size: 13px;
        }
        .filter-group input, .filter-group select {
            padding: 10px 14px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-family: 'Inter', sans-serif;
            font-size: 13px;
            background: white;
            transition: all 0.3s ease;
            height: 36px;
        }
        .filter-group input:focus, .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* --- KPI Cards (IMPROVED) --- */
        .kpi-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:16px; }
        .kpi-card {
            background: linear-gradient(145deg, #ffffff, #f6f6f6);
            padding: 16px 12px;
            border-radius: 16px;
            text-align: center;
            border: 2px solid #2f2f2f;
            box-shadow: 0 4px 0 #2f2f2f, 0 6px 16px rgba(0, 0, 0, 0.12);
            transition: all 0.2s ease;
            cursor: pointer;
            height: 120px; /* Increased height for better proportions */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .kpi-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 0 #2f2f2f, 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        .kpi-title {
            font-size: 14px; /* Increased from 11px */
            color: #666;
            margin-bottom: 8px; /* Increased from 6px */
            font-weight: 600;
            text-transform: uppercase;
        }
        .kpi-value {
            font-size: 36px; /* Increased from 24px */
            font-weight: 800;
            color: #333;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1.1;
        }

        /* --- Chart & Results Containers (IMPROVED) --- */
        .charts-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(400px,1fr)); gap:20px; }
        .chart-container, .results-container {
            background: rgba(255, 255, 255, 0.98);
            padding: 24px; /* Increased padding */
            border-radius: 16px;
            border: 2px solid #2f2f2f;
            box-shadow: 0 4px 0 #2f2f2f, 0 6px 20px rgba(0, 0, 0, 0.12);
            transition: all 0.2s ease;
        }
        .chart-container { height: 420px; }
        .chart-container h2, .results-container h2 {
            font-size: 14px;
            font-weight: 700;
            color: #333;
            margin-bottom: 24px; /* Increased margin to push chart down */
            text-align: center;
            text-transform: uppercase;
        }


        /* --- Feedback Log Items --- */
        .results-container p { text-align: center; color: #666; padding: 20px; }
        .feedback-item { border-bottom:1px solid #eee; padding: 16px 4px; }
        .feedback-item:last-child { border-bottom: none; }
        .feedback-meta { color:#555; font-size:0.9rem; margin-bottom:8px; }
        .feedback-text { margin-top: 8px; font-size: 0.95rem; line-height: 1.5; }
        .tag {
            font-size: 0.75rem;
            color: #fff;
            background-color: #667eea;
            border-radius: 4px;
            padding: 2px 6px;
            margin-right: 8px;
            font-weight: 500;
        }

        /* --- Loader --- */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            z-index: 1000;
            display: none;
        }
        #loader p { color: #fff; margin-top: 20px; }
        #loader .spinner {
            border: 8px solid rgba(255,255,255,0.3);
            border-top: 8px solid #fff;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    </style>
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
        <p>Loading...</p>
    </div>

    <div class="container">
        <div class="main-header">
             <a href="dashboard.html" class="btn-3d btn-refresh">‚Üê Back</a>
            <h1>Student Feedback History</h1>
        </div>

        <div class="filters">
            <div class="filter-group">
                <label for="regNoInput">Student RegNo.</label>
                <input type="text" id="regNoInput" placeholder="Enter RegNo...">
            </div>
            <div class="filter-group"><label for="startDate">Start Date</label><input type="date" id="startDate"></div>
            <div class="filter-group"><label for="endDate">End Date</label><input type="date" id="endDate"></div>
            <div class="filter-group"><label for="teacherFilter">Teacher</label><select id="teacherFilter"><option value="all">All Teachers</option></select></div>
            <button id="searchBtn" class="btn-3d btn-export">Search</button>
            <button id="exportCsvBtn" class="btn-3d btn-refresh" style="margin-left:auto;">Export CSV</button>
        </div>

        <div id="analyticsSection" style="display: none;">
            <div id="kpiGrid" class="kpi-grid">
                <div class="kpi-card"><div class="kpi-title">Total Reviews</div><div id="kpiTotalReviews" class="kpi-value">-</div></div>
                <div class="kpi-card"><div class="kpi-title">Avg. Rating Given</div><div id="kpiAvgRating" class="kpi-value">-</div></div>
                <div class="kpi-card"><div class="kpi-title">Most Rated Teacher</div><div id="kpiMostRated" class="kpi-value">-</div></div>
                <div class="kpi-card"><div class="kpi-title">Feedback Frequency</div><div id="kpiFrequency" class="kpi-value">-</div></div>
            </div>
            <br>
            <div class="charts-grid">
                 <div class="chart-container"><h2>Rating Distribution</h2><canvas id="distChart"></canvas></div>
                 <div class="chart-container"><h2>Rating Over Time</h2><canvas id="timeChart"></canvas></div>
            </div>
        </div>

        <div id="resultsContainer" class="results-container">
            <p>Enter a registration number and click Search to see feedback.</p>
        </div>
    </div>

<script>
        const API_URL = "https://raw.githubusercontent.com/rajnishpandey21/fac_rat_data/main/manifest.json";

        let allData = [];
        let filteredFeedback = [];
        let distChart, timeChart;

        function showLoader(message = 'Loading...') {
            document.getElementById('loader').querySelector('p').textContent = message;
            document.getElementById('loader').style.display = 'flex';
            document.querySelectorAll('.filters input, .filters select, .filters button').forEach(el => el.disabled = true);
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
            document.querySelectorAll('.filters input, .filters select, .filters button').forEach(el => el.disabled = false);
        }

        document.addEventListener('DOMContentLoaded', async () => {
            showLoader('Loading initial data...');
            
            const urlParams = new URLSearchParams(window.location.search);
            const regNoFromUrl = urlParams.get('regNo');
            const startDateFromUrl = urlParams.get('startDate');
            const endDateFromUrl = urlParams.get('endDate');
            
            const startDateEl = document.getElementById('startDate');
            const endDateEl = document.getElementById('endDate');

            if (startDateFromUrl) startDateEl.value = startDateFromUrl;
            else { const d = new Date('2025-02-01T00:00:00'); startDateEl.value = d.toISOString().split('T')[0]; }

            if (endDateFromUrl) endDateEl.value = endDateFromUrl;
            else { const t = new Date(); endDateEl.value = t.toISOString().split('T')[0]; }

            try {
                console.log("Fetching data manifest from GitHub...");
                const manifestResponse = await fetch(API_URL);
                if (!manifestResponse.ok) throw new Error(`HTTP Error: ${manifestResponse.status}`);
                const manifest = await manifestResponse.json();

                const baseUrl = API_URL.substring(0, API_URL.lastIndexOf('/') + 1);

                // Fetch all data part files concurrently
                const reviewPromises = manifest.review_files.map(file => 
                    fetch(baseUrl + file).then(res => res.json())
                );
                
                const reviewChunks = await Promise.all(reviewPromises);
                
                // Combine the chunks into a single array
                allData = [].concat(...reviewChunks);

            } catch (e) {
                document.getElementById('resultsContainer').innerHTML = `<p>Error loading data: ${e.message}</p>`;
                hideLoader();
                return;
            }

            populateTeacherFilter();

            if (regNoFromUrl) {
                document.getElementById('regNoInput').value = regNoFromUrl;
                performSearch();
            } else {
                hideLoader();
            }
            
            document.getElementById('searchBtn').addEventListener('click', performSearch);
            document.getElementById('exportCsvBtn').addEventListener('click', exportToCsv);
        });

        function populateTeacherFilter() {
            const teacherFilterEl = document.getElementById('teacherFilter');
            const teachersMap = new Map();
            allData.forEach(r => { if(!teachersMap.has(r.teacherId)) teachersMap.set(r.teacherId, r.teacherName); });
            const teachers = [...teachersMap.entries()].sort((a,b)=>a[1].localeCompare(b[1]));
            teachers.forEach(([id, name]) => teacherFilterEl.add(new Option(name, id)));
        }

        function performSearch() {
            showLoader('Searching...');
            const regNo = document.getElementById('regNoInput').value.trim();
            const start = new Date(document.getElementById('startDate').value + 'T00:00:00').getTime();
            const end = new Date(document.getElementById('endDate').value + 'T23:59:59').getTime();
            const teacherId = document.getElementById('teacherFilter').value;
            const resultsContainer = document.getElementById('resultsContainer');
            const analyticsSection = document.getElementById('analyticsSection');

            analyticsSection.style.display = 'none';

            if (!regNo) {
                resultsContainer.innerHTML = '<p>Please enter a registration number.</p>';
                hideLoader();
                return;
            }

            setTimeout(() => {
                filteredFeedback = allData.filter(d => {
                    const isMatch = d.studentRegNo && String(d.studentRegNo).toLowerCase() === regNo.toLowerCase();
                    const inDate = d.timestamp >= start && d.timestamp <= end;
                    const teacherMatch = (teacherId === 'all' || d.teacherId === teacherId);
                    return isMatch && inDate && teacherMatch;
                }).sort((a, b) => b.timestamp - a.timestamp);

                if (filteredFeedback.length === 0) {
                    resultsContainer.innerHTML = `<p>No feedback found for <strong>${regNo}</strong> with the current filters.</p>`;
                    hideLoader();
                    return;
                }
                
                analyticsSection.style.display = 'block';
                updateKpis(filteredFeedback);
                renderCharts(filteredFeedback);

                resultsContainer.innerHTML = `<h2>Feedback Log (${filteredFeedback.length})</h2>` + filteredFeedback.map(item => {
                    const d = new Date(item.timestamp);
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    const dateStr = `${year}-${month}-${day}`;
                    const commentHTML = (item.comments || '').trim() ? `<div class="feedback-text"><span class="tag">Comment</span>${item.comments}</div>` : '';
                    const suggestionHTML = (item.suggestions || '').trim() ? `<div class="feedback-text"><span class="tag">Suggestion</span>${item.suggestions}</div>` : '';
                    
                    return `<div class="feedback-item">
                                <div class="feedback-meta">
                                    <strong>Date:</strong> ${dateStr} | 
                                    <strong>Teacher:</strong> ${item.teacherName} | 
                                    <strong>Rating:</strong> ${item.avgRating.toFixed(2)}
                                </div>
                                ${commentHTML}
                                ${suggestionHTML}
                            </div>`;
                }).join('');
                hideLoader();
            }, 50);
        }
        
        function updateKpis(data) {
            document.getElementById('kpiTotalReviews').textContent = data.length;
            
            const avgRating = data.reduce((sum, item) => sum + item.avgRating, 0) / data.length;
            document.getElementById('kpiAvgRating').textContent = avgRating.toFixed(2);

            const teacherCounts = data.reduce((acc, item) => {
                acc[item.teacherName] = (acc[item.teacherName] || 0) + 1;
                return acc;
            }, {});
            const mostRated = Object.keys(teacherCounts).sort((a,b) => teacherCounts[b] - teacherCounts[a])[0];
            document.getElementById('kpiMostRated').textContent = mostRated || 'N/A';

            if (data.length > 1) {
                const firstReview = data[data.length - 1].timestamp;
                const lastReview = data[0].timestamp;
                const days = (lastReview - firstReview) / 86400000;
                const months = Math.max(days / 30.44, 1);
                const frequency = data.length / months;
                document.getElementById('kpiFrequency').textContent = `${frequency.toFixed(1)}/month`;
            } else {
                document.getElementById('kpiFrequency').textContent = 'N/A';
            }
        }
        
        function renderCharts(data) {
            const ratingCounts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
            data.forEach(item => {
                const rounded = Math.round(item.avgRating);
                if (ratingCounts[rounded] !== undefined) ratingCounts[rounded]++;
            });
            if (distChart) distChart.destroy();
            distChart = new Chart(document.getElementById('distChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'],
                    datasets: [{
                        label: 'Number of Ratings',
                        data: Object.values(ratingCounts),
                        backgroundColor: 'rgba(74, 58, 255, 0.7)',
                        maxBarThickness: 100
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    layout: { padding: { top: 10, bottom: 20 } },
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { stepSize: 1 },
                            title: { display: true, text: 'Number of Reviews', font: { size: 14 } }
                        },
                        x: {
                            title: { display: true, text: 'Star Rating', font: { size: 14 } }
                        }
                    }
                }
            });

            const monthlyRatings = data.reduce((acc, item) => {
                const month = new Date(item.timestamp).toISOString().slice(0, 7);
                if (!acc[month]) acc[month] = [];
                acc[month].push(item.avgRating);
                return acc;
            }, {});
            const labels = Object.keys(monthlyRatings).sort();
            const avgMonthlyData = labels.map(month => monthlyRatings[month].reduce((a, b) => a + b, 0) / monthlyRatings[month].length);
            if (timeChart) timeChart.destroy();
            timeChart = new Chart(document.getElementById('timeChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Average Rating Given',
                        data: avgMonthlyData,
                        borderColor: 'rgba(74, 58, 255, 1)',
                        tension: 0.2,
                        fill: true,
                        backgroundColor: 'rgba(74, 58, 255, 0.1)'
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    layout: { padding: { top: 10, bottom: 20 } },
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            suggestedMin: 3.5,
                            suggestedMax: 5,
                            title: { display: true, text: 'Average Rating', font: { size: 14 } }
                        },
                        x: {
                            title: { display: true, text: 'Month', font: { size: 14 } }
                        }
                    }
                }
            });
        }

        function exportToCsv() {
            if (filteredFeedback.length === 0) { alert('No data to export.'); return; }
            const headers = ['Date', 'Student RegNo', 'Teacher', 'Rating', 'Comment', 'Suggestion'];
            const rows = filteredFeedback.map(item => [ new Date(item.timestamp).toISOString().split('T')[0], item.studentRegNo, item.teacherName, item.avgRating.toFixed(2), item.comments || '', item.suggestions || '' ]);
            const escapeCsvCell = (cell) => { let value = String(cell || ''); if (/[",\n\r]/.test(value)) { value = `"${value.replace(/"/g, '""')}"`; } return value; };
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += headers.map(escapeCsvCell).join(',') + '\r\n';
            rows.forEach(rowArray => { let row = rowArray.map(escapeCsvCell).join(','); csvContent += row + '\r\n'; });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `student_feedback_${document.getElementById('regNoInput').value.trim()}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>

